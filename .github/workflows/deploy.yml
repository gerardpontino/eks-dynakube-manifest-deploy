name: Deploy Dynatrace (Dev)

on:
  push:
    branches: [ develop ]

permissions:
  id-token: write
  contents: read

concurrency:
  group: dynatrace-dev
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy Dynatrace to EKS (Dev)
    environment: development
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-southeast-1
      EKS_CLUSTER: gerard-dev-cluster
      DYNATRACE_NAMESPACE: dynatrace

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Authenticate to AWS via OIDC
      - name: AWS Authenticate (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubEKSCluster
          aws-region: ${{ env.AWS_REGION }}

      # 3Ô∏è‚É£ Update kubeconfig for EKS
      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig \
            --name $EKS_CLUSTER \
            --region $AWS_REGION

      # 4Ô∏è‚É£ Verify cluster access
      - name: Verify cluster access
        run: |
          kubectl get nodes
          kubectl get ns

      # 5Ô∏è‚É£ Setup Helm
      - name: Setup Helm
        uses: azure/setup-helm@v4

      # 6Ô∏è‚É£ Install / Upgrade Dynatrace Operator
      - name: Install Dynatrace Operator
        run: |
          helm upgrade --install dynatrace-operator \
            oci://public.ecr.aws/dynatrace/dynatrace-operator \
            --namespace $DYNATRACE_NAMESPACE \
            --create-namespace \
            --atomic \
            --wait

      # 7Ô∏è‚É£ Validate Dynatrace token variables
      - name: Validate Dynatrace token variables
        run: |
          echo "API Token length: ${#DT_API_TOKEN}"
          echo "Data Ingest Token length: ${#DT_DATA_INGEST_TOKEN}"
        env:
          DT_API_TOKEN: ${{ secrets.DT_API_TOKEN }}
          DT_DATA_INGEST_TOKEN: ${{ secrets.DT_DATA_INGEST_TOKEN }}

      # 8Ô∏è‚É£ Create / Update Dynatrace secret
      - name: Create Dynatrace Secret in EKS
        run: |
          kubectl create secret generic dynatrace-tokens \
            -n $DYNATRACE_NAMESPACE \
            --from-literal="apiToken=${{ secrets.DT_API_TOKEN }}" \
            --from-literal="dataIngestToken=${{ secrets.DT_DATA_INGEST_TOKEN }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      # 9Ô∏è‚É£ Apply Dynakube manifest
      - name: Apply Dynakube Manifest
        run: |
          kubectl apply -f kubernetes/dynatrace/dynakube.yaml

      # üîü Verify Dynatrace deployment
      - name: Verify Dynatrace rollout
        run: |
          kubectl get pods -n $DYNATRACE_NAMESPACE
          kubectl get dynakube -n $DYNATRACE_NAMESPACE

      # üîç Debug if failed
      - name: Debug if failed
        if: failure()
        run: |
          kubectl get pods -n $DYNATRACE_NAMESPACE
          kubectl describe pods -n $DYNATRACE_NAMESPACE
